# Lightweight audit on PR (npm audit + comment). Full audit + reports on schedule only.
name: Security Audit & Dependency Check

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'

jobs:
  dependency-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --production=false

      - name: Run npm audit
        run: |
          npm audit --json > audit-results.json || true
          npm audit --audit-level=high --production

      - name: Check for high/critical vulnerabilities
        run: |
          HIGH_VULNS=$(npm audit --json --production 2>/dev/null | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(npm audit --json --production 2>/dev/null | jq '.metadata.vulnerabilities.critical // 0')
          echo "High vulnerabilities (production): $HIGH_VULNS"
          echo "Critical vulnerabilities (production): $CRITICAL_VULNS"
          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "Found high or critical vulnerabilities in production dependencies!"
            npm audit --audit-level=high --production
            exit 1
          fi

      - name: Check outdated packages
        run: |
          npm outdated --json > outdated-packages.json || true

      - name: License compliance check
        if: github.event_name == 'schedule'
        run: |
          npx license-checker --summary --production --json > license-report.json

      - name: Security best practices check
        if: github.event_name == 'schedule'
        run: |
          if ! grep -q "helmet" package.json; then echo "Security headers middleware (helmet) not found"; fi
          if ! grep -q "express-rate-limit" package.json; then echo "Rate limiting middleware not found"; fi
          if ! grep -q "express-validator" package.json; then echo "Input validation middleware not found"; fi

      - name: Generate security report
        if: github.event_name == 'schedule'
        run: |
          cat > security-report.md << EOF
          # Security Audit Report
          ## Dependency Vulnerabilities
          \`\`\`json
          $(cat audit-results.json)
          \`\`\`
          ## Outdated Packages
          \`\`\`json
          $(cat outdated-packages.json)
          \`\`\`
          ## License Summary
          \`\`\`json
          $(cat license-report.json 2>/dev/null || echo "{}")
          \`\`\`
          Generated on: $(date)
          EOF

      - name: Upload security artifacts
        if: github.event_name == 'schedule'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: security-reports
          path: |
            audit-results.json
            outdated-packages.json
            license-report.json
            security-report.md
          retention-days: 30

      - name: Comment PR with security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const fs = require('fs');
            let auditData = {};
            let outdatedData = {};
            try {
              auditData = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
              outdatedData = JSON.parse(fs.readFileSync('outdated-packages.json', 'utf8'));
            } catch (e) {}
            const vulnerabilities = auditData.metadata?.vulnerabilities || {};
            const outdatedCount = Object.keys(outdatedData).length;
            const comment = `## Security Audit Summary
            ### Vulnerabilities
            - Critical: ${vulnerabilities.critical || 0}
            - High: ${vulnerabilities.high || 0}
            - Moderate: ${vulnerabilities.moderate || 0}
            - Low: ${vulnerabilities.low || 0}
            ### Package Status
            - Outdated packages: ${outdatedCount}
            - Total dependencies: ${auditData.metadata?.dependencies?.total || 'N/A'}
            ${vulnerabilities.high > 0 || vulnerabilities.critical > 0 ? '**Action required**: Update packages with high/critical vulnerabilities.' : 'No critical vulnerabilities found.'}
            View detailed reports in the workflow artifacts (scheduled runs).`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  supply-chain-security:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check package-lock.json integrity
        run: |
          if [ ! -f package-lock.json ]; then
            echo "package-lock.json not found - supply chain risk!"
            exit 1
          fi
          npm ci --dry-run

      - name: Analyze dependency tree
        run: |
          npm ls --all --json > dependency-tree.json || true
          npm ls --json | jq -r '.dependencies | keys[]' | grep -E '^[a-z]{1,3}$|[0-9]' || true

      - name: Check for dev dependencies in production
        run: |
          npm ci --omit=dev
          npm ls --omit=dev --json > prod-dependencies.json
          npm ls --omit=dev --parseable | wc -l

      - name: Validate package sources
        run: |
          if ! npm config get registry | grep -q "registry.npmjs.org"; then
            echo "Non-standard npm registry detected"
            npm config get registry
          fi

  sca-analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Run Snyk security scan
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            npx snyk test --json > snyk-results.json || true
            npx snyk monitor || true
          else
            echo "SNYK_TOKEN not configured, skipping Snyk scan"
          fi

      - name: Upload Snyk results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: snyk-results
          path: snyk-results.json
          retention-days: 30

  scorecard:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      security-events: write
      id-token: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Run OSSF Scorecard
        uses: ossf/scorecard-action@4a0b87a20cc42672e6c80e82e63b5cd8f25f108a
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true

  security-policy-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Check security policy files
        run: |
          [ -f SECURITY.md ] && echo "SECURITY.md found" || echo "SECURITY.md not found"
          [ -f LICENSE ] || [ -f LICENSE* ] || [ -f LICENSING.md ] && echo "License file found" || echo "License file not found"
          [ -f .nvmrc ] || grep -q "engines" package.json && echo "Node version constraints found" || echo "No Node version constraints"

      - name: Validate security configuration
        run: |
          if grep -q "process.env.NODE_ENV" server.js; then echo "Environment-based configuration found"; else echo "Consider NODE_ENV checks for production"; fi
