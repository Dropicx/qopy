# On-demand security fix PR only. Regular dependency PRs are handled by Dependabot.
name: Manual Security Fix (npm audit)

on:
  workflow_dispatch:

jobs:
  npm-audit-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Run npm audit fix
        id: audit
        run: |
          echo "Running npm audit fix..."
          npm audit fix --audit-level=moderate || true
          if git diff --quiet package*.json; then
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "No security fixes needed"
          else
            echo "changes_made=true" >> $GITHUB_OUTPUT
          fi

      - name: Test after security fixes
        if: steps.audit.outputs.changes_made == 'true'
        run: |
          npm install
          npm test

      - name: Create security fix PR
        if: steps.audit.outputs.changes_made == 'true'
        uses: peter-evans/create-pull-request@4e1beaa7521e8b457b572c090b25bd3db56bf1c5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: apply automated security fixes"
          title: "Automated security vulnerability fixes"
          body: |
            ## Security Vulnerability Fixes

            This PR applies automated fixes for security vulnerabilities found by `npm audit`.

            - Applied `npm audit fix` for moderate+ vulnerabilities
            - All tests passing
            - Generated by Manual Security Fix workflow (Actions â†’ workflow_dispatch)
          branch: security-fixes/automated
          delete-branch: true
          labels: |
            security
            automated
